!function(e){function t(s){if(n[s])return n[s].exports;var i=n[s]={exports:{},id:s,loaded:!1};return e[s].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var i=n(3),r=s(i),o=new r.default;self.addEventListener("connect",function(e){var t=e.ports[0],n=function(e){var n=Object.assign({},e,{callback:null});console.log("**** SENDING MESSAGE ****",n),t.postMessage(n)};t.addEventListener("message",function(e){console.log("Did receive message",e),o.send(Object.assign({callback:n},e.data))},!0),t.start()},!1)},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={pingInterval:15e3,jobTimeout:1e4,localStorage:{eventKey:"domsevent",metaStorageKey:"domsstorage"},indexedDb:{db:"domsevent",objectType:"domsevent"}};t.default=n},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),i=function(){function e(t,s,i){n(this,e),this.uuid=t,this.lastPing=s,this.registeredJobs=[],this.assignedJobs=[],this.isActive=!0,this.callback=i}return s(e,[{key:"didPing",value:function(e){return this.lastPing=e,this}},{key:"removeAssignedJob",value:function(e){var t=this.assignedJobs.indexOf(e);return t>-1&&this.assignedJobs.splice(t,1),this}},{key:"addAssignedJob",value:function(e){var t=this.assignedJobs.indexOf(e);return t===-1&&this.assignedJobs.push(e),this}},{key:"removeRegisteredJob",value:function(e){var t=this.registeredJobs.indexOf(e);return t>-1&&this.registeredJobs.splice(t,1),this}},{key:"addRegisteredJob",value:function(e){var t=this.registeredJobs.indexOf(e);return t===-1&&this.registeredJobs.push(e),this}}]),e}();t.default=i},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageTypes=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(7),a=s(o),u=n(1),l=s(u),c=n(2),d=s(c),g=n(4),f=s(g),h=n(5),v=n(6),b=(s(v),(0,a.default)("CronDaemon.js",3)),y=t.MessageTypes={PING:"PING",REGISTERJOB:"REGISTER-JOB",ASSIGNEDJOB:"ASSIGNED-JOB",PINGJOB:"PING-JOB",JOBCOMPLETED:"JOB-COMPLETED",UNREGISTERASSIGNEE:"UNREGISTER-ASSIGNEE",UNREGISTERJOB:"UNREGISTER-JOB"},p=function(){function e(t,n){i(this,e),this.localUuid=t||null,this.localCallback=n||null,this.assignees=[],this.jobs=[],this.ready=!1,this.pendingMessages=[],this.isWorker=!t&&!n,this.register(),b.log("Jobs?",this.jobs)}return r(e,[{key:"register",value:function(){var e=this;if(this.isWorker)(0,h.getStore)(function(t){var n=t.get("cache");n.onsuccess=n.onerror=function(){if(n.result){var t=n.result.state.jobs;e.jobs=t.map(function(e){var t=new f.default;return b.log("Trying to restore job",e,t),Object.assign(t,e)})}e.ready=!0,e.pendingMessages.forEach(function(t){return e.onReceive(t)}),e.houseKeeping(),setInterval(function(){return e.houseKeeping()},100)}});else{var t=window.localStorage.getItem(l.default.localStorage.metaStorageKey);if(t)try{var n=JSON.parse(t),s=n.assignees,i=n.jobs;this.assignees=s.map(function(e){var t=new d.default;return Object.assign(t,e)}),this.jobs=i.map(function(e){var t=new f.default;return b.log("Trying to restore job",e,t),Object.assign(t,e)})}catch(e){b.warn("Cached state unreadable",e)}b.warn("Restored state",t),this.ready=!0,this.houseKeeping(),window.addEventListener("storage",function(t){return e.onReceiveMessage(t)}),setInterval(function(){return e.houseKeeping()},1e3),setInterval(function(){return e.persistState()},1e3)}}},{key:"houseKeeping",value:function(){var e=this,t=this.now(),n=t-l.default.pingInterval;this.assignees.filter(function(e){return e.lastPing<n}).forEach(function(t){var n=t.uuid;return e.unregisterAssignee(n)}),this.jobs.filter(function(e){var n=e.interval,s=e.lastSucceeded,i=e.assignees;return 0===i.length&&s<t-n}).forEach(function(t){return e.unregisterJob(t)});var s=t-l.default.jobTimeout;this.jobs.filter(function(e){var t=e.assignedTo,n=e.lastAssigned;return null!==t&&n<s}).forEach(function(t){return e.distributeJob(t)}),this.jobs.filter(function(e){var n=e.assignedTo,s=e.interval,i=e.lastSucceeded;return null===n&&i<t-s}).forEach(function(t){return e.distributeJob(t)})}},{key:"persistState",value:function(){var e=this;if(this.isWorker)!function(){var t={jobs:e.jobs};(0,h.getStore)(function(e){b.debug("Saving state",t),e.put({state:t,key:"cache"})})}();else{var t={assignees:this.assignees,jobs:this.jobs},n=window.localStorage.getItem(l.default.localStorage.metaStorageKey),s=JSON.stringify(t);n!==s&&window.localStorage.setItem(l.default.localStorage.metaStorageKey,s)}}},{key:"emit",value:function(e){b.warn("Emiting message",e);var t=JSON.stringify(e);return this.lastMessage=t,window.localStorage.setItem(l.default.localStorage.eventKey,t),this}},{key:"send",value:function(e){return this.ready?this.onReceive(e):this.pendingMessages.push(e),this.isWorker||this.emit(e),this}},{key:"onReceiveMessage",value:function(e){if(e.key===l.default.localStorage.eventKey&&e.newValue!==this.lastMessage)return this.onReceive(JSON.parse(e.newValue)),this}},{key:"onReceive",value:function(e){switch(b.debug("Received message",e),e.type){case y.PING:this.onReceivePing(e);break;case y.REGISTERJOB:this.onReceiveRegisterJob(e);break;case y.ASSIGNEDJOB:this.onReceiveJobAssigned(e);break;case y.PINGJOB:this.onReceivePingJob(e);break;case y.UNREGISTERASSIGNEE:this.onReceiveUnregisterAssignee(e);break;case y.JOBCOMPLETED:this.onReceiveJobCompleted(e);break;case y.UNREGISTERJOB:this.onReceiveUnregisterJob(e);break;default:b.warn("Unrecognised message type")}if(this.isWorker)switch(e.type){case y.UNREGISTERASSIGNEE:case y.JOBCOMPLETED:this.persistState()}}},{key:"onReceivePing",value:function(e){var t=this.getAssignee(e.uuid);return null===t?this.registerAssignee(e.uuid,e.callback):void t.didPing(this.now())}},{key:"onReceiveUnregisterAssignee",value:function(e){var t=e.uuid;this.unregisterAssignee(t),this.isWorker&&0===this.assignees.length&&(b.warn("Shared worker is about to die. Save state now"),this.persistState())}},{key:"onReceiveRegisterJob",value:function(e){var t=e.uuid,n=e.data,s=this.registerJob(n);s.addAssignee(t);var i=this.getAssignee(t);if(i.addRegisteredJob(s.name),s.lastSucceeded>0){var r={type:y.JOBCOMPLETED,job:s.name,data:s.lastResponse};this.localUuid!==t&&this.localCallback?this.localCallback(r):i.callback&&i.callback(r)}}},{key:"onReceiveUnregisterJob",value:function(e){var t=e.uuid,n=e.job,s=this.getAssignee(t),i=this.getJob(n);i.removeAssignee(t),s.removeAssignedJob(n).removeRegisteredJob(n)}},{key:"onReceiveJobAssigned",value:function(e){var t=e.uuid,n=e.job;this.getJob(n).setAssignedTo(t,this.now());var s=this.getAssignee(t).addAssignedJob(n);t===this.localUuid&&this.localCallback?this.localCallback(e):s.callback&&(b.warn("Trying to emit message over postMessage",s),s.callback(e))}},{key:"onReceivePingJob",value:function(e){var t=e.uuid,n=e.job,s=this.getJob(n);s.assignedTo===t&&s.setAssignedTo(t,this.now())}},{key:"onReceiveJobCompleted",value:function(e){var t=e.uuid,n=e.job,s=e.data;this.getAssignee(t).removeAssignedJob(n),this.getJob(n).setCompleted(this.now(),s),this.localUuid!==t&&this.localCallback?this.getAssignee(this.localUuid).registeredJobs.indexOf(n)>-1&&this.localCallback(e):this.localCallback||this.assignees.filter(function(e){return e.uuid!==t&&e.registeredJobs.indexOf(n)>-1}).forEach(function(t){return t.callback(e)})}},{key:"distributeJob",value:function(e){b.warn("DISTRIBUTING JOB",this.now()-e.lastSucceeded);var t=this.assignees.filter(function(t){return t.registeredJobs.indexOf(e.name)>-1}).sort(function(e,t){if(t.isActive&&!e.isActive)return 1;if(e.isActive&&!t.isActive)return-1;var n=e.assignedJobs.length,s=t.assignedJobs.length;return n===s?t.lastPing-e.lastPing:n-s});if(0===t.length)return b.error("No assignees for job",e),void this.unregisterJob(e);var n=t.filter(function(e){return e.isActive});n.length?this.assignJob(n[0],e):this.assignJob(t[0],e)}},{key:"assignJob",value:function(e,t){this.send({uuid:e.uuid,job:t.name,type:y.ASSIGNEDJOB})}},{key:"registerAssignee",value:function(e,t){var n=new d.default(e,this.now(),t);b.debug("Adding assignee to the pool",n),this.assignees.push(n)}},{key:"unregisterAssignee",value:function(e){var t=this,n=this.getAssignee(e);if(null!==n){var s=this.assignees.indexOf(n);this.assignees.splice(s,1),n.registeredJobs.forEach(function(n){var s=t.getJob(n),i=s.assignees.indexOf(e);i!==-1&&s.assignees.splice(i,1)}),n.assignedJobs.forEach(function(e){var n=t.getJob(e);n.assignedTo=null}),b.debug("Removing assignee from pool",n)}}},{key:"getAssignee",value:function(e){var t=this.assignees.filter(function(t){return e===t.uuid});return 0===t.length?null:t[0]}},{key:"registerJob",value:function(e){var t=e.name,n=e.interval,s=this.getJob(t);if(null!==s)return b.debug("Amending job",e),s.setInterval(n),s;b.debug("Registering job",e);var i=new f.default(t,n);return this.jobs.push(i),i}},{key:"unregisterJob",value:function(e){var t=this;this.jobs.filter(function(t){var n=t.name;return n===e.name}).forEach(function(e){var n=t.jobs.indexOf(e);t.jobs.splice(n,1)})}},{key:"getJob",value:function(e){var t=this.jobs.filter(function(t){return e===t.name});return 0===t.length?null:t[0]}},{key:"now",value:function(){return Date.now()}}]),e}();t.default=p},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),i=function(){function e(t,s){n(this,e),this.name=t,this.interval=s,this.lastSucceeded=0,this.lastResponse=null,this.assignedTo=null,this.assignees=[]}return s(e,[{key:"setInterval",value:function(e){this.interval=e}},{key:"setAssignedTo",value:function(e,t){this.assignedTo=e,this.lastAssigned=t}},{key:"setCompleted",value:function(e,t){this.lastSucceeded=e,this.lastResponse=t,this.assignedTo=null}},{key:"removeAssignee",value:function(e){var t=this.assignees.indexOf(e);t>-1?this.assignees.splice(t,1):console.warn("Couldnt find uuid to remove",e,this),this.assignedTo===e&&(this.assignedTo=null)}},{key:"addAssignee",value:function(e){var t=this.assignees.indexOf(e);t===-1&&this.assignees.push(e)}}]),e}();t.default=i},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.getStore=void 0;var i=n(1),r=s(i),o="undefined"!=typeof self?self:o,a=o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,u=r.default.indexedDb.db,l=r.default.indexedDb.objectType,c=null,d=null,g=null,f=function(){d=c.result,g=d.createObjectStore(l,{keyPath:"key"}),console.log("upgradeNeeded")},h=function(){d=c.result;var e=d.transaction(l,"readwrite");g=e.objectStore(l),console.log("store loaded")},v=function(e){var t=d.transaction(l,"readwrite"),n=t.objectStore(l);e(n)};t.getStore=function(e){c||(c=a.open(u,1),c.addEventListener("upgradeneeded",f),c.addEventListener("success",h)),d?v(e):c.addEventListener("success",function(){return v(e)})}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function e(t){if("object"!==("undefined"==typeof t?"undefined":n(t)))return t;if(t instanceof Array){var s=[].concat(t);s.map(e)}var i=Object.assign({},t);return Object.keys(i).forEach(function(t){i[t]=e(i[t])}),i};t.default=s},function(e,t){"use strict";function n(){for(var e={},t=s,n=arguments.length,c=Array(n),d=0;d<n;d++)c[d]=arguments[d];"number"==typeof c[c.length-1]&&(t=c.splice(c.length-1,1),s<t&&(t=s));var g="#"+c.join("/")+":";return i.forEach(function(n,s){s<=t?a?e[n]=function(){u!==g&&(null!==u&&(o.groupEnd(),clearTimeout(l)),o.group(g),u=g,l=setTimeout(function(){o.groupEnd(),u=null},16));for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(o[n]||o.log).apply(o,t)}:e[n]=function(){var e;return(o[n]||o.log).apply(o,(e=[g]).concat.apply(e,arguments))}:e[n]=r}),e}Object.defineProperty(t,"__esModule",{value:!0});var s=/not minified/.test(function(){})?3:0,i=["error","warn","log","debug"],r=function(){},o=console,a=!!o.group,u=null,l=null;t.default=n}]);