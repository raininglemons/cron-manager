!function(e){function t(n){if(s[n])return s[n].exports;var i=s[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var i=s(2),o=n(i),r=new o.default;self.addEventListener("connect",function(e){var t=e.ports[0],s=function(e){var s=Object.assign({},e,{callback:null});console.log("**** SENDING MESSAGE ****",s),t.postMessage(s)};t.addEventListener("message",function(e){console.log("Did receive message",e),r.send(Object.assign({callback:s},e.data))},!0),t.start()},!1)},function(e,t){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),i=function(){function e(t,n,i){s(this,e),this.uuid=t,this.lastPing=n,this.registeredJobs=[],this.assignedJobs=[],this.isActive=!0,this.callback=i}return n(e,[{key:"didPing",value:function(e){return this.lastPing=e,this}},{key:"removeAssignedJob",value:function(e){var t=this.assignedJobs.indexOf(e);return t>-1&&this.assignedJobs.splice(t,1),this}},{key:"addAssignedJob",value:function(e){var t=this.assignedJobs.indexOf(e);return t===-1&&this.assignedJobs.push(e),this}},{key:"removeRegisteredJob",value:function(e){var t=this.registeredJobs.indexOf(e);return t>-1&&this.registeredJobs.splice(t,1),this}},{key:"addRegisteredJob",value:function(e){var t=this.registeredJobs.indexOf(e);return t===-1&&this.registeredJobs.push(e),this}}]),e}();t.default=i},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageTypes=void 0;var o=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),r=s(4),a=n(r),u=s(1),l=n(u),c=s(3),g=n(c),d=t.MessageTypes={PING:"PING",REGISTERJOB:"REGISTER-JOB",ASSIGNEDJOB:"ASSIGNED-JOB",PINGJOB:"PING-JOB",JOBCOMPLETED:"JOB-COMPLETED",UNREGISTERASSIGNEE:"UNREGISTER-ASSIGNEE",UNREGISTERJOB:"UNREGISTER-JOB"},f=function(){function e(t,s){var n=this;i(this,e),this.localUuid=t||null,this.localCallback=s||null,this.assignees=[],this.jobs=[],this.register(),console.log("Jobs?",this.jobs),setInterval(function(){return n.houseKeeping()},1e3),s&&setInterval(function(){return n.persistState()},1e3)}return o(e,[{key:"register",value:function(){var e=this;if(this.localUuid&&this.localCallback){var t=window.localStorage.getItem(a.default.localStorage.metaStorageKey);if(t)try{var s=JSON.parse(t),n=s.assignees,i=s.jobs;this.assignees=n.map(function(e){var t=new l.default;return Object.assign(t,e)}),this.jobs=i.map(function(e){var t=new g.default;return console.log("Trying to restore job",e,t),Object.assign(t,e)})}catch(e){console.warn("Cached state unreadable",e)}console.warn("Restored state",t),window.addEventListener("storage",function(t){return e.onReceiveMessage(t)})}}},{key:"houseKeeping",value:function(){var e=this,t=this.now(),s=t-a.default.pingInterval;this.assignees.filter(function(e){return e.lastPing<s}).forEach(function(t){var s=t.uuid;return e.unregisterAssignee(s)}),this.jobs.filter(function(e){var s=e.interval,n=e.lastSucceeded,i=e.assignees;return 0===i.length&&n<t-s}).forEach(function(t){return e.unregisterJob(t)});var n=t-a.default.jobTimeout;this.jobs.filter(function(e){var t=e.assignedTo,s=e.lastAssigned;return null!==t&&s<n}).forEach(function(t){return e.distributeJob(t)}),this.jobs.filter(function(e){var s=e.assignedTo,n=e.interval,i=e.lastSucceeded;return null===s&&i<t-n}).forEach(function(t){return e.distributeJob(t)})}},{key:"persistState",value:function(){var e=window.localStorage.getItem(a.default.localStorage.metaStorageKey),t=JSON.stringify({assignees:this.assignees,jobs:this.jobs});e!==t&&window.localStorage.setItem(a.default.localStorage.metaStorageKey,t)}},{key:"emit",value:function(e){console.warn("Emiting message",e);var t=JSON.stringify(e);return this.lastMessage=t,window.localStorage.setItem(a.default.localStorage.eventKey,t),this}},{key:"send",value:function(e){return console.warn("Receieved message locally",e),this.onReceive(e),this.localUuid&&this.localCallback&&this.emit(e),this}},{key:"onReceiveMessage",value:function(e){if(e.key===a.default.localStorage.eventKey&&e.newValue!==this.lastMessage)return this.onReceive(JSON.parse(e.newValue)),this}},{key:"onReceive",value:function(e){switch(console.debug("Received message",e),e.type){case d.PING:return this.onReceivePing(e);case d.REGISTERJOB:return this.onReceiveJobRegistration(e);case d.ASSIGNEDJOB:return this.onReceiveJobAssigned(e);case d.PINGJOB:return this.onReceivePingJob(e);case d.UNREGISTERASSIGNEE:return this.onReceiveUnregisterAssignee(e);case d.JOBCOMPLETED:return this.onReceiveJobCompleted(e);case d.UNREGISTERJOB:return this.onReceiveUnregisterJob(e);default:console.warn("Unrecognised message type")}}},{key:"onReceivePing",value:function(e){var t=this.getAssignee(e.uuid);return null===t?this.registerAssignee(e.uuid,e.callback):void t.didPing(this.now())}},{key:"onReceiveUnregisterAssignee",value:function(e){var t=e.uuid;this.unregisterAssignee(t)}},{key:"onReceiveJobRegistration",value:function(e){var t=e.uuid,s=e.data,n=this.registerJob(s);n.addAssignee(t);var i=this.getAssignee(t);i.registeredJobs.indexOf(n.name)===-1&&i.registeredJobs.push(n.name)}},{key:"onReceiveUnregisterJob",value:function(e){var t=e.uuid,s=e.job,n=this.getAssignee(t),i=this.getJob(s);i.removeAssignee(t),n.removeAssignedJob(s).removeRegisteredJob(s)}},{key:"onReceiveJobAssigned",value:function(e){var t=e.uuid,s=e.job;this.getJob(s).setAssignedTo(t,this.now());var n=this.getAssignee(t).addAssignedJob(s);t===this.localUuid&&this.localCallback?this.localCallback(e):(console.warn("Trying to emit message over postMessage",n),n.callback(e))}},{key:"onReceivePingJob",value:function(e){var t=e.uuid,s=e.job,n=this.getJob(s);n.assignedTo===t&&n.setAssignedTo(t,this.now())}},{key:"onReceiveJobCompleted",value:function(e){var t=e.uuid,s=e.job,n=e.data;this.getAssignee(t).removeAssignedJob(s),this.getJob(s).setCompleted(this.now(),n),this.localUuid!==t&&this.localCallback?this.getAssignee(this.localUuid).registeredJobs.indexOf(s)>-1&&this.localCallback(e):this.assignees.filter(function(e){return e.uuid!==t&&e.registeredJobs.indexOf(s)>-1}).forEach(function(t){return t.callback(e)})}},{key:"distributeJob",value:function(e){console.warn("DISTRIBUTING JOB",this.now()-e.lastSucceeded);var t=this.assignees.filter(function(t){return t.registeredJobs.indexOf(e.name)>-1}).sort(function(e,t){if(t.isActive&&!e.isActive)return 1;if(e.isActive&&!t.isActive)return-1;var s=e.assignedJobs.length,n=t.assignedJobs.length;return s===n?t.lastPing-e.lastPing:s-n});if(0===t.length)return console.error("No assignees for job",e),void this.unregisterJob(e);var s=t.filter(function(e){return e.isActive});s.length?this.assignJob(s[0],e):this.assignJob(t[0],e)}},{key:"assignJob",value:function(e,t){this.send({uuid:e.uuid,job:t.name,type:d.ASSIGNEDJOB})}},{key:"registerAssignee",value:function(e,t){var s=new l.default(e,this.now(),t);console.debug("Adding assignee to the pool",s),this.assignees.push(s)}},{key:"unregisterAssignee",value:function(e){var t=this,s=this.getAssignee(e);if(null!==s){var n=this.assignees.indexOf(s);this.assignees.splice(n,1),s.registeredJobs.forEach(function(s){var n=t.getJob(s),i=n.assignees.indexOf(e);i!==-1&&n.assignees.splice(i,1)}),console.debug("Removing assignee from pool",s)}}},{key:"getAssignee",value:function(e){var t=this.assignees.filter(function(t){return e===t.uuid});return 0===t.length?null:t[0]}},{key:"registerJob",value:function(e){var t=e.name,s=e.interval,n=this.getJob(t);if(null!==n)return console.debug("Amending job",e),n.setInterval(s),n;console.debug("Registering job",e);var i=new g.default(t,s);return this.jobs.push(i),i}},{key:"unregisterJob",value:function(e){var t=this;this.jobs.filter(function(t){var s=t.name;return s===e.name}).forEach(function(e){var s=t.jobs.indexOf(e);t.jobs.splice(s,1)})}},{key:"getJob",value:function(e){var t=this.jobs.filter(function(t){return e===t.name});return 0===t.length?null:t[0]}},{key:"now",value:function(){return Date.now()}}]),e}();t.default=f},function(e,t){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),i=function(){function e(t,n){s(this,e),this.name=t,this.interval=n,this.lastSucceeded=0,this.lastResponse=null,this.assignedTo=null,this.assignees=[]}return n(e,[{key:"setInterval",value:function(e){this.interval=e}},{key:"setAssignedTo",value:function(e,t){this.assignedTo=e,this.lastAssigned=t}},{key:"setCompleted",value:function(e,t){this.lastSucceeded=e,this.lastResponse=t,this.assignedTo=null}},{key:"removeAssignee",value:function(e){var t=this.assignees.indexOf(e);t>-1?this.assignees.splice(t,1):console.warn("Couldnt find uuid to remove",e,this),this.assignedTo===e&&(this.assignedTo=null)}},{key:"addAssignee",value:function(e){var t=this.assignees.indexOf(e);t===-1&&this.assignees.push(e)}}]),e}();t.default=i},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s={pingInterval:15e3,jobTimeout:1e4,localStorage:{eventKey:"domsevent",metaStorageKey:"domsstorage"}};t.default=s}]);